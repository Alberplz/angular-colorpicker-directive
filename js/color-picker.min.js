"use strict"
var colorPicker=angular.module("colorpicker",[]).factory("ColorHelper",function(){return{hsla2hsva:function(e){var t=Math.min(e.h,1),o=Math.min(e.s,1),a=Math.min(e.l,1),r=Math.min(e.a,1)
if(0===a)return{h:t,s:0,v:0,a:r}
var n=a+o*(1-Math.abs(2*a-1))/2
return{h:t,s:2*(n-a)/n,v:n,a:r}},hsva2hsla:function(e){var t=e.h,o=e.s,a=e.v,r=e.a
if(0===a)return{h:t,s:0,l:0,a:r}
if(0===o&&1===a)return{h:t,s:1,l:1,a:r}
var n=a*(2-o)/2
return{h:t,s:a*o/(1-Math.abs(2*n-1)),l:n,a:r}},rgbaToHsva:function(e){var t,o,a=Math.min(e.r,1),r=Math.min(e.g,1),n=Math.min(e.b,1),s=Math.min(e.a,1),i=Math.max(a,r,n),l=Math.min(a,r,n),c=i,u=i-l
if(o=0===i?0:u/i,i===l)t=0
else{switch(i){case a:t=(r-n)/u+(n>r?6:0)
break
case r:t=(n-a)/u+2
break
case n:t=(a-r)/u+4}t/=6}return{h:t,s:o,v:c,a:s}},hsvaToRgba:function(e){var t,o,a,r=e.h,n=e.s,s=e.v,i=e.a,l=Math.floor(6*r),c=6*r-l,u=s*(1-n),p=s*(1-c*n),h=s*(1-(1-c)*n)
switch(l%6){case 0:t=s,o=h,a=u
break
case 1:t=p,o=s,a=u
break
case 2:t=u,o=s,a=h
break
case 3:t=u,o=p,a=s
break
case 4:t=h,o=u,a=s
break
case 5:t=s,o=u,a=p}return{r:t,g:o,b:a,a:i}},stringToHsva:function(e){var t=[{re:/(rgb)a?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*%?,\s*(\d{1,3})\s*%?(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return["rgb",parseInt(e[2]),parseInt(e[3]),parseInt(e[4]),isNaN(parseFloat(e[5]))?1:parseFloat(e[5])]}},{re:/(hsl)a?\(\s*(\d{1,3})\s*,\s*(\d{1,3})%\s*,\s*(\d{1,3})%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(e){return["hsl",parseInt(e[2]),parseInt(e[3]),parseInt(e[4]),isNaN(parseFloat(e[5]))?1:parseFloat(e[5])]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})$/,parse:function(e){return["hex",parseInt(e[1],16),parseInt(e[2],16),parseInt(e[3],16),1]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])$/,parse:function(e){return["hex",parseInt(e[1]+e[1],16),parseInt(e[2]+e[2],16),parseInt(e[3]+e[3],16),1]}}]
e=e.toLowerCase()
var o=null
for(var a in t)if(t.hasOwnProperty(a)){var r=t[a],n=r.re.exec(e),s=n&&r.parse(n)
if(s)return o="hex"===s[0]||"rgb"===s[0]?this.rgbaToHsva({r:s[1]/255,g:s[2]/255,b:s[3]/255,a:s[4]}):this.hsla2hsva({h:s[1]/360,s:s[2]/100,l:s[3]/100,a:s[4]})}return o}}})
colorPicker.directive("colorPicker",["$document","$compile","ColorHelper",function(e,t,o){return{restrict:"A",scope:{colorPickerModel:"=",colorPickerOutputFormat:"="},controller:["$scope",function(e){function t(e){return{r:Math.round(255*e.r),g:Math.round(255*e.g),b:Math.round(255*e.b),a:e.a}}e.show=!1,e.sAndLMax={},e.hueMax={},e.alphaMax={},e.type=0,e.hsva={h:.5,s:1,v:1,a:1},e.hueSlider={left:0},e.sAndLSlider={left:0,top:0},e.alphaSlider={left:0},e.rbgaSteps={r:1,g:1,b:1,a:.1},e.hslaSteps={h:1,s:1,l:1,a:.1},e.cancelButtonClass="",e.showCancelButton=!1,e.extraLargeClass="","rgba"===e.colorPickerOutputFormat?e.type=1:"hsla"===e.colorPickerOutputFormat&&(e.type=2),e.setSaturation=function(t,a){var r=o.hsva2hsla(e.hsva)
r.s=t/a,e.hsva=o.hsla2hsva(r)},e.setLightness=function(t,a){var r=o.hsva2hsla(e.hsva)
r.l=t/a,e.hsva=o.hsla2hsva(r)},e.setHue=function(t,o){e.hsva.h=t/o},e.setAlpha=function(t,o){e.hsva.a=t/o},e.setR=function(t,a){var r=o.hsvaToRgba(e.hsva)
r.r=t/a,e.hsva=o.rgbaToHsva(r)},e.setG=function(t,a){var r=o.hsvaToRgba(e.hsva)
r.g=t/a,e.hsva=o.rgbaToHsva(r)},e.setB=function(t,a){var r=o.hsvaToRgba(e.hsva)
r.b=t/a,e.hsva=o.rgbaToHsva(r)},e.setSaturationAndBrightness=function(t,o,a,r){e.hsva.s=t/a,e.hsva.v=o/r},e.update=function(){var a=o.hsva2hsla(e.hsva)
e.hslaText={h:Math.round(360*a.h),s:Math.round(100*a.s),l:Math.round(100*a.l),a:Math.round(100*a.a)/100}
var r=t(o.hsvaToRgba(e.hsva)),n=t(o.hsvaToRgba({h:e.hsva.h,s:1,v:1,a:1}))
if(e.rgbaText={r:r.r,g:r.g,b:r.b,a:Math.round(100*r.a)/100},e.hexText="#"+(1<<24|parseInt(r.r,10)<<16|parseInt(r.g,10)<<8|parseInt(r.b,10)).toString(16).substr(1),e.hexText[1]===e.hexText[2]&&e.hexText[3]===e.hexText[4]&&e.hexText[5]===e.hexText[6]&&(e.hexText="#"+e.hexText[1]+e.hexText[3]+e.hexText[5]),e.alphaSliderColor="rgb("+r.r+","+r.g+","+r.b+")",e.hueSliderColor="rgb("+n.r+","+n.g+","+n.b+")",0===e.type&&e.hsva.a<1&&e.type++,e.hsva.a<1)switch(e.colorPickerOutputFormat){case"hsla":e.outputColor="hsla("+e.hslaText.h+","+e.hslaText.s+"%,"+e.hslaText.l+"%,"+e.hslaText.a+")"
break
default:e.outputColor="rgba("+r.r+","+r.g+","+r.b+","+Math.round(100*r.a)/100+")"}else switch(e.colorPickerOutputFormat){case"hsla":e.outputColor="hsl("+e.hslaText.h+","+e.hslaText.s+"%,"+e.hslaText.l+"%)"
break
case"rgba":e.outputColor=e.alphaSliderColor
break
default:e.outputColor=e.hexText}e.sAndLSlider={left:e.hsva.s*e.sAndLMax.x-8+"px",top:(1-e.hsva.v)*e.sAndLMax.y-8+"px"},e.hueSlider.left=e.hsva.h*e.hueMax.x-8+"px",e.alphaSlider.left=e.hsva.a*e.alphaMax.x-8+"px",e.alphaInvalidClass=""},e.setColorFromHex=function(t){var a=o.stringToHsva(t)
return null!==a&&(e.hsva=a),a},e.typePolicy=function(){return e.type=(e.type+1)%3,0===e.type&&e.hsva.a<1&&e.type++,e.type}}],link:function(a,r,n){function s(e){var t=o.stringToHsva(e)
null!==t&&(a.hsva=t,a.update())}function i(){setTimeout(function(){l()},5)}function l(){a.$apply(function(){n.colorPickerShowValue="true",s(r.val()),a.colorPickerModel=r.val()})}function c(t){var o
f=a.colorPickerModel,a.$apply(function(){a.show=!0}),"true"===n.colorPickerFixedPosition?(o=d(r[0],!1),v[0].style.position="fixed"):o=d(r[0],!0),"left"===n.colorPickerPosition?(v[0].style.top=o.top+"px",v[0].style.left=o.left-252+"px"):"top"===n.colorPickerPosition?(v[0].style.top=o.top-o.height-284+"px",v[0].style.left=o.left+"px"):"bottom"===n.colorPickerPosition?(v[0].style.top=o.top+o.height+10+"px",v[0].style.left=o.left+"px"):(v[0].style.top=o.top+"px",v[0].style.left=o.left+o.width+"px"),a.$apply(function(){a.sAndLMax={x:v[0].getElementsByClassName("saturation-lightness")[0].offsetWidth,y:v[0].getElementsByClassName("saturation-lightness")[0].offsetHeight},a.hueMax={x:v[0].getElementsByClassName("hue")[0].offsetWidth},a.alphaMax={x:v[0].getElementsByClassName("alpha")[0].offsetWidth},a.update()}),e.on("mousedown",u),e.on("mouseup",p)}function u(e){"INPUT"!==e.target.tagName&&"HTML"!==e.target.tagName&&e.preventDefault(),g=v[0]===e.target||h(v[0],e.target)||"HTML"===e.target.tagName?!1:!0}function p(t){g&&t.target!==r[0]&&v[0]!==t.target&&!h(v[0],t.target)&&(a.$apply(function(){a.show=!1}),e.off("mouseup",p),e.off("mousedown",u))}function h(e,t){for(var o=t.parentNode;null!==o;){if(o===e)return!0
o=o.parentNode}return!1}function d(e,t){return{top:e.getBoundingClientRect().top+(t?window.pageYOffset:0),left:e.getBoundingClientRect().left+(t?window.pageXOffset:0),width:e.offsetWidth,height:e.offsetHeight}}var v,g=!1,f=""
if(void 0===a.colorPickerModel&&(a.colorPickerModel="#008fff",r.val("")),void 0===n.colorPickerShowValue&&(n.colorPickerShowValue="true"),void 0===n.colorPickerPosition&&(n.colorPickerPosition="right"),void 0===n.colorPickerShowInputSpinner&&(n.colorPickerShowInputSpinner="false"),void 0===n.colorPickerShowCancelButton&&(n.colorPickerShowCancelButton="false"),"true"===n.colorPickerShowCancelButton&&(a.showCancelButton=!0,a.extraLargeClass="color-picker-extra-large"),void 0!==n.colorPickerCancelButtonClass&&(a.cancelButtonClass=n.colorPickerCancelButtonClass),void 0!==n.colorPickerSpinnerRgbaSteps&&null!==n.colorPickerSpinnerRgbaSteps.match(/^\d+;\d+;\d+;[0-9]+([\.][0-9]{1,2})?$/)){var x=n.colorPickerSpinnerRgbaSteps.split(";")
a.rbgaSteps={r:x[0],g:x[1],b:x[2],a:x[3]}}if(void 0!==n.colorPickerSpinnerHslaSteps&&null!==n.colorPickerSpinnerHslaSteps.match(/^\d+;\d+;\d+;[0-9]+([\.][0-9]{1,2})?$/)){var x=n.colorPickerSpinnerHslaSteps.split(";")
a.hslaSteps={h:x[0],s:x[1],l:x[2],a:x[3]}}s(a.colorPickerModel),"true"===n.colorPickerShowValue&&r.val(a.outputColor),v=angular.element('<div ng-show="show" class="color-picker {{extraLargeClass}}">   <div class="arrow arrow-'+n.colorPickerPosition+'"></div><div slider rg-x=1 rg-y=1 action="setSaturationAndBrightness(s, v, rgX, rgY)" class="saturation-lightness" ng-style="{\'background-color\':hueSliderColor}"><div class="cursor-sv" ng-style="{\'top\':sAndLSlider.top, \'left\':sAndLSlider.left}"></div></div><div slider rg-x=1 action="setHue(v, rg)" class="hue"><div class="cursor" ng-style="{\'left\':hueSlider.left}"></div></div><div slider rg-x=1 action="setAlpha(v, rg)" class="alpha" ng-style="{\'background-color\':alphaSliderColor}"><div class="cursor" ng-style="{\'left\':alphaSlider.left}"></div></div><div class="selected-color-background"></div><div class="selected-color" ng-style="{\'background-color\':outputColor}"></div><div ng-show="type==2" class="hsla-text"><input text type="number" pattern="[0-9]*" min="0" max="360" step="'+a.hslaSteps.h+'" rg=360 action="setHue(v, rg)" ng-model="hslaText.h" spinner="'+n.colorPickerShowInputSpinner+'" /><input text type="number" pattern="[0-9]*" min="0" max="100" step="'+a.hslaSteps.s+'" rg=100 action="setSaturation(v, rg)" ng-model="hslaText.s" spinner="'+n.colorPickerShowInputSpinner+'" /><input text type="number" pattern="[0-9]*" min="0" max="100" step="'+a.hslaSteps.l+'" rg=100 action="setLightness(v, rg)" ng-model="hslaText.l" spinner="'+n.colorPickerShowInputSpinner+'" /><input text type="number" pattern="[0-9]+([.,][0-9]{1,2})?" min="0" max="1" step="'+a.hslaSteps.a+'" rg=1 action="setAlpha(v, rg)" ng-model="hslaText.a" spinner="'+n.colorPickerShowInputSpinner+'" /><div>H</div><div>S</div><div>L</div><div>A</div></div><div ng-show="type==1" class="rgba-text"><input text type="number" pattern="[0-9]*" min="0" max="255" step="'+a.rbgaSteps.r+'" rg=255 action="setR(v, rg)" ng-model="rgbaText.r" spinner="'+n.colorPickerShowInputSpinner+'" /><input text type="number" pattern="[0-9]*" min="0" max="255" step="'+a.rbgaSteps.g+'" rg=255 action="setG(v, rg)" ng-model="rgbaText.g" spinner="'+n.colorPickerShowInputSpinner+'" /><input text type="number" pattern="[0-9]*" min="0" max="255" step="'+a.rbgaSteps.b+'" rg=255 action="setB(v, rg)" ng-model="rgbaText.b" spinner="'+n.colorPickerShowInputSpinner+'" /><input text type="number" pattern="[0-9]+([.,][0-9]{1,2})?" min="0" max="1" step="'+a.rbgaSteps.a+'" rg=1 action="setAlpha(v, rg)" ng-model="rgbaText.a" spinner="'+n.colorPickerShowInputSpinner+'" /><div>R</div><div>G</div><div>B</div><div>A</div></div><div class="hex-text" ng-show="type==0"><input text type="text" action="setColorFromHex(string)" ng-model="hexText"/><div>HEX</div></div><div ng-click="typePolicy()" class="type-policy"></div><button type="button" class="{{cancelButtonClass}}" ng-show="showCancelButton" ng-click="cancelColor()">Cancel</button></div>'),document.getElementsByTagName("body")[0].appendChild(v[0]),t(v)(a),r.on("paste",i),r.on("keyup",l),a.$on("color-changed",function(e){a.$apply(function(){a.update(),a.colorPickerModel=a.outputColor,"true"===n.colorPickerShowValue&&r.val(a.outputColor)})}),a.cancelColor=function(){a.colorPickerModel=f,a.show=!1,s(a.colorPickerModel),e.off("mouseup",p),e.off("mousedown",u)},r.on("click",c),r.on("$destroy",function(){r.off("click",c),r.off("keyup",l),r.off("paste",i)})}}}]),colorPicker.directive("text",[function(){return{restrict:"A",scope:{action:"&"},link:function(e,t,o,a){function r(e){"true"===o.spinner&&t.removeClass("color-picker-input-spinner")}function n(e){t.addClass("color-picker-input-spinner")}function s(e){setTimeout(function(){i(e)},5)}function i(a){if(void 0===o.rg)e.action({string:t.val()})&&e.$emit("color-changed")
else{var r=parseFloat(t.val())
isNaN(r)?e.$emit("alpha-invalid"):(r=Math.abs(Math.min(parseFloat(t.val()),o.rg)),e.action({v:r,rg:o.rg}),e.$emit("color-changed"),e.$emit("alpha-valid"))}}t.on("paste",s),t.on("keyup",i),t.on("change",i),t.on("focus",r),t.on("blur",n),t.on("mouseover",r),t.on("mouseout",n),t.addClass("color-picker-input-spinner"),t.on("$destroy",function(){t.off("paste",s),t.off("keyup",i),t.off("change",i),t.off("focus",r),t.off("blur",n),t.off("mouseover",r),t.off("mouseout",n)})}}}]),colorPicker.directive("slider",["$document","$window",function(e,t){return{restrict:"A",scope:{action:"&"},link:function(o,a,r){function n(t){i(t),e.on("mousemove",s)}function s(e){i(e)}function i(e){var t=a[0].offsetHeight,n=a[0].offsetWidth,s=Math.max(0,Math.min(l(e,a[0]),n)),i=Math.max(0,Math.min(c(e,a[0]),t))
void 0!==r.rgX&&void 0!==r.rgY?o.action({s:s/n,v:1-i/t,rgX:r.rgX,rgY:r.rgY}):o.action({v:s/n,rg:r.rgX}),o.$emit("color-changed")}function l(e,o){return e.pageX-o.getBoundingClientRect().left-t.pageXOffset}function c(e,o){return e.pageY-o.getBoundingClientRect().top-t.pageYOffset}a.on("mousedown",n),e.on("mouseup",function(){e.off("mousemove",s)}),a.on("$destroy",function(){a.off("mousedown",n)})}}}])
