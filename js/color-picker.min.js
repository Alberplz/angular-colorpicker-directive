"use strict"
var colorPicker=angular.module("colorpicker",[]).factory("ColorHelper",function(){return{hsla2hsva:function(t){var e=t.h,o=t.s,a=t.l,r=t.a,s=a+o*(1-Math.abs(2*a-1))/2
return{h:e,s:2*(s-a)/s,v:s,a:r}},hsva2hsla:function(t){var e=t.h,o=t.s,a=t.v,r=t.a
if(0===a)return{h:e,s:0,l:0,a:r}
if(0===o&&1===a)return{h:e,s:1,l:1,a:r}
var s=a*(2-o)/2
return{h:e,s:a*o/(1-Math.abs(2*s-1)),l:s,a:r}},rgbaToHsva:function(t){var e,o,a=t.r,r=t.g,s=t.b,n=t.a,i=Math.max(a,r,s),l=Math.min(a,r,s),c=i,u=i-l
if(o=0===i?0:u/i,i===l)e=0
else{switch(i){case a:e=(r-s)/u+(s>r?6:0)
break
case r:e=(s-a)/u+2
break
case s:e=(a-r)/u+4}e/=6}return{h:e,s:o,v:c,a:n}},hsvaToRgba:function(t){var e,o,a,r=t.h,s=t.s,n=t.v,i=t.a,l=Math.floor(6*r),c=6*r-l,u=n*(1-s),h=n*(1-c*s),d=n*(1-(1-c)*s)
switch(l%6){case 0:e=n,o=d,a=u
break
case 1:e=h,o=n,a=u
break
case 2:e=u,o=n,a=d
break
case 3:e=u,o=h,a=n
break
case 4:e=d,o=u,a=n
break
case 5:e=n,o=u,a=h}return{r:e,g:o,b:a,a:i}},stringToHsva:function(t){var e=[{re:/rgba?\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(t){return[t[1],t[2],t[3],t[4]]}},{re:/rgba?\(\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*,\s*(\d+(?:\.\d+)?)\%\s*(?:,\s*(\d+(?:\.\d+)?)\s*)?\)/,parse:function(t){return[2.55*t[1],2.55*t[2],2.55*t[3],t[4]]}},{re:/#([a-fA-F0-9]{2})([a-fA-F0-9]{2})([a-fA-F0-9]{2})$/,parse:function(t){return[parseInt(t[1],16),parseInt(t[2],16),parseInt(t[3],16)]}},{re:/#([a-fA-F0-9])([a-fA-F0-9])([a-fA-F0-9])$/,parse:function(t){return[parseInt(t[1]+t[1],16),parseInt(t[2]+t[2],16),parseInt(t[3]+t[3],16)]}}]
t=t.toLowerCase()
var o=null
for(var a in e)if(e.hasOwnProperty(a)){var r=e[a],s=r.re.exec(t),n=s&&r.parse(s)
if(n)return o=this.rgbaToHsva({r:n[0]/255,g:n[1]/255,b:n[2]/255,a:1}),isNaN(parseFloat(n[3]))?o.a=1:o.a=parseFloat(n[3]),o}return o}}})
colorPicker.directive("colorPicker",["$document","$compile","ColorHelper",function(t,e,o){return{restrict:"A",scope:{colorPickerModel:"="},controller:["$scope",function(t){function e(t){return{r:Math.round(255*t.r),g:Math.round(255*t.g),b:Math.round(255*t.b),a:t.a}}t.show=!1,t.sAndLMax={},t.hueMax={},t.alphaMax={},t.type=0,t.hsva={h:.5,s:1,v:1,a:1},t.hueSlider={left:0},t.sAndLSlider={left:0,top:0},t.alphaSlider={left:0},t.setSaturation=function(e,a){var r=o.hsva2hsla(t.hsva)
r.s=e/a,t.hsva=o.hsla2hsva(r)},t.setLightness=function(e,a){var r=o.hsva2hsla(t.hsva)
r.l=e/a,t.hsva=o.hsla2hsva(r)},t.setHue=function(e,o){t.hsva.h=e/o},t.setAlpha=function(e,o){t.hsva.a=e/o},t.setR=function(e,a){var r=o.hsvaToRgba(t.hsva)
r.r=e/a,t.hsva=o.rgbaToHsva(r)},t.setG=function(e,a){var r=o.hsvaToRgba(t.hsva)
r.g=e/a,t.hsva=o.rgbaToHsva(r)},t.setB=function(e,a){var r=o.hsvaToRgba(t.hsva)
r.b=e/a,t.hsva=o.rgbaToHsva(r)},t.setSaturationAndBrightness=function(e,o,a,r){t.hsva.s=e/a,t.hsva.v=o/r},t.update=function(){var a=o.hsva2hsla(t.hsva)
t.hslaText={h:Math.round(360*a.h),s:Math.round(100*a.s),l:Math.round(100*a.l),a:Math.round(100*a.a)/100}
var r=e(o.hsvaToRgba(t.hsva)),s=e(o.hsvaToRgba({h:t.hsva.h,s:1,v:1,a:1}))
t.rgbaText={r:r.r,g:r.g,b:r.b,a:Math.round(100*r.a)/100},t.hexText="#"+(1<<24|parseInt(r.r,10)<<16|parseInt(r.g,10)<<8|parseInt(r.b,10)).toString(16).substr(1),t.hexText[1]===t.hexText[2]&&t.hexText[3]===t.hexText[4]&&t.hexText[5]===t.hexText[6]&&(t.hexText="#"+t.hexText[1]+t.hexText[3]+t.hexText[5]),t.hsva.a<1?t.outputColor="rgba("+r.r+","+r.g+","+r.b+","+Math.round(100*r.a)/100+")":t.outputColor=t.hexText,t.alphaSliderColor="rgb("+r.r+","+r.g+","+r.b+")",t.hueSliderColor="rgb("+s.r+","+s.g+","+s.b+")",0===t.type&&t.hsva.a<1&&t.type++,t.sAndLSlider={left:t.hsva.s*t.sAndLMax.x-8+"px",top:(1-t.hsva.v)*t.sAndLMax.y-8+"px"},t.hueSlider.left=t.hsva.h*t.hueMax.x-8+"px",t.alphaSlider.left=t.hsva.a*t.alphaMax.x-8+"px"},t.setColorFromHex=function(e){var a=o.stringToHsva(e)
return null!==a&&(t.hsva=a),a},t.typePolicy=function(){return t.type=(t.type+1)%3,0===t.type&&t.hsva.a<1&&t.type++,t.type}}],link:function(a,r,s){function n(t){var e=o.stringToHsva(t)
null!==e&&(a.hsva=e,a.update())}function i(){a.$apply(function(){s.colorPickerShowValue="true",n(r.val())})}function l(e){function o(t){"INPUT"!==t.target.tagName&&"HTML"!==t.target.tagName&&t.preventDefault(),d=h[0]===t.target||c(h[0],t.target)||"HTML"===t.target.tagName?!1:!0}function n(e){d&&e.target!==r[0]&&h[0]!==e.target&&!c(h[0],e.target)&&(a.$apply(function(){a.show=!1}),t.off("mouseup",n),t.off("mousedown",o))}var i
a.$apply(function(){a.show=!0}),"true"===s.colorPickerFixedPosition?(i=u(r[0],!1),h[0].style.position="fixed"):i=u(r[0],!0),"left"===s.colorPickerPosition?(h[0].style.top=i.top+"px",h[0].style.left=i.left-252+"px"):"top"===s.colorPickerPosition?(h[0].style.top=i.top-i.height-284+"px",h[0].style.left=i.left+"px"):"bottom"===s.colorPickerPosition?(h[0].style.top=i.top+i.height+10+"px",h[0].style.left=i.left+"px"):(h[0].style.top=i.top+"px",h[0].style.left=i.left+i.width+"px"),a.$apply(function(){a.sAndLMax={x:h[0].getElementsByClassName("saturation-lightness")[0].offsetWidth,y:h[0].getElementsByClassName("saturation-lightness")[0].offsetHeight},a.hueMax={x:h[0].getElementsByClassName("hue")[0].offsetWidth},a.alphaMax={x:h[0].getElementsByClassName("alpha")[0].offsetWidth},a.update()}),t.on("mousedown",o),t.on("mouseup",n)}function c(t,e){for(var o=e.parentNode;null!==o;){if(o===t)return!0
o=o.parentNode}return!1}function u(t,e){return{top:t.getBoundingClientRect().top+(e?window.pageYOffset:0),left:t.getBoundingClientRect().left+(e?window.pageXOffset:0),width:t.offsetWidth,height:t.offsetHeight}}var h,d=!1
void 0===a.colorPickerModel&&(a.colorPickerModel="#008fff",r.val("")),void 0===s.colorPickerShowValue&&(s.colorPickerShowValue="true"),void 0===s.colorPickerPosition&&(s.colorPickerPosition="right"),n(a.colorPickerModel),"true"===s.colorPickerShowValue&&r.val(a.outputColor),h=angular.element('<div ng-show="show" class="color-picker"><div class="arrow arrow-'+s.colorPickerPosition+'"></div><div slider rg-x=1 rg-y=1 action="setSaturationAndBrightness(s, v, rgX, rgY)" class="saturation-lightness" ng-style="{\'background-color\':hueSliderColor}"><div class="cursor-sv" ng-style="{\'top\':sAndLSlider.top, \'left\':sAndLSlider.left}"></div></div><div slider rg-x=1 action="setHue(v, rg)" class="hue"><div class="cursor" ng-style="{\'left\':hueSlider.left}"></div></div><div slider rg-x=1 action="setAlpha(v, rg)" class="alpha" ng-style="{\'background-color\':alphaSliderColor}"><div class="cursor" ng-style="{\'left\':alphaSlider.left}"></div></div><div class="selected-color-background"></div><div class="selected-color" ng-style="{\'background-color\':outputColor}"></div><div ng-show="type==2" class="hsla-text"><input text rg=360 action="setHue(v, rg)" ng-model="hslaText.h"/><input text rg=100 action="setSaturation(v, rg)" ng-model="hslaText.s"/><input text rg=100 action="setLightness(v, rg)" ng-model="hslaText.l"/><input text rg=1 action="setAlpha(v, rg)" ng-model="hslaText.a"/><div>H</div><div>S</div><div>L</div><div>A</div></div><div ng-show="type==1" class="rgba-text"><input text rg=255 action="setR(v, rg)" ng-model="rgbaText.r"/><input text rg=255 action="setG(v, rg)" ng-model="rgbaText.g"/><input text rg=255 action="setB(v, rg)" ng-model="rgbaText.b"/><input text rg=1 action="setAlpha(v, rg)" ng-model="rgbaText.a"/><div>R</div><div>G</div><div>B</div><div>A</div></div><div class="hex-text" ng-show="type==0"><input text action="setColorFromHex(string)" ng-model="hexText"/><div>Hex</div></div><div ng-click="typePolicy()" class="type-policy"></div></div>'),document.getElementsByTagName("body")[0].appendChild(h[0]),e(h)(a),r.on("keyup",i),a.$on("color-changed",function(t){a.$apply(function(){a.update(),a.colorPickerModel=a.outputColor,"true"===s.colorPickerShowValue&&r.val(a.outputColor)})}),r.on("click",l),r.on("$destroy",function(){r.off("click",l),r.off("keyup",i)})}}}]),colorPicker.directive("text",[function(){return{restrict:"A",scope:{action:"&"},link:function(t,e,o){function a(a){if(void 0===o.rg)t.action({string:e[0].value})&&t.$emit("color-changed")
else{var r=parseFloat(e[0].value)
isNaN(r)||"."===e[0].value.slice(-1)||(r=Math.min(parseFloat(e[0].value),o.rg),t.action({v:r,rg:o.rg}),t.$emit("color-changed"))}}e.on("keyup",a),e.on("$destroy",function(){e.off("keyup",a)})}}}]),colorPicker.directive("slider",["$document","$window",function(t,e){return{restrict:"A",scope:{action:"&"},link:function(o,a,r){function s(e){i(e),t.on("mousemove",n)}function n(t){i(t)}function i(t){var e=a[0].offsetHeight,s=a[0].offsetWidth,n=Math.max(0,Math.min(l(t,a[0]),s)),i=Math.max(0,Math.min(c(t,a[0]),e))
void 0!==r.rgX&&void 0!==r.rgY?o.action({s:n/s,v:1-i/e,rgX:r.rgX,rgY:r.rgY}):void 0===r.rgX&&void 0!==r.rgY?o.action({v:i/e,rg:r.rgY}):o.action({v:n/s,rg:r.rgX}),o.$emit("color-changed")}function l(t,o){return t.pageX-o.getBoundingClientRect().left-e.pageXOffset}function c(t,o){return t.pageY-o.getBoundingClientRect().top-e.pageYOffset}a.on("mousedown",s),t.on("mouseup",function(){t.off("mousemove",n)}),a.on("$destroy",function(){a.off("mousedown",s)})}}}])
